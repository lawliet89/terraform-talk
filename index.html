<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Infrastructure as code with Terraform</title>

	<link rel="stylesheet" href="css/reveal.css">
	<link rel="stylesheet" href="css/theme/black.css">
	<link rel="stylesheet" type="text/css" href="lib/css/asciinema-player.css" />

	<!-- Theme used for syntax highlighting of code -->
	<link rel="stylesheet" href="lib/css/zenburn.css">

	<style>
		.flex_box {
			display: flex;
		}

		.flex_box > div {
			margin: 10px;
		}

		.flex_box li {
			font-size: 75%;
		}
	</style>

	<!-- Printing and PDF exports -->
	<script>
		var link = document.createElement('link');
		link.rel = 'stylesheet';
		link.type = 'text/css';
		link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
		document.getElementsByTagName('head')[0].appendChild(link);
	</script>
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section>
				<section>
					Automating the α and the Ω of Your Infrastructure
					<small>Automatic creation and destruction through Infrastructure as code</small>

					<aside class="notes">
						<p>
							Managing huge and complex infrastructure is difficult. The same problem exists even when running your own bare metal racks
							or on the cloud. Nowadays, many cloud providers and stacks provide rich sets of API for users to manage and run their
							infrastructure. This is ripe for software to automate the management of infrastructure. </p>

						<p>
							Using Infrastructure as Code allows us to track changes, reason about infrastructure and even reproduce an exact replica
							of the infrastructure. Terraform is one such tool that works across many cloud providers and service providers such
							as Cloudflare.
						</p>

					</aside>
				</section>
				<section>
					<ul>
						<li>Slides: <a href="https://terraform.gds-gov.tech">terraform.gds-gov.tech</a></li>
						<li>Source code and demo code: <a href="https://github.com/lawliet89/terraform-talk">github.com/lawliet89/terraform-talk</a></li>
					</ul>
				</section>
			</section>

			<section>
				<section>
					<h2>Problems with Managing Infrastructure (Manually)
					</h2>
				</section>

				<section>
					<h3>Visibility</h3>
					<ul>
						<li>Details are siloed in someone's head</li>
						<li>Changes are not visible</li>
						<li>Dependencies are hard to see</li>
					</ul>

					<aside class="notes">
						<ul>
							<li>Difficult to see the whole "big picture" of your infrastructure configuration</li>
							<li>Difficult to tell what the rationale for some of the configuration is</li>
							<li>Changes are not easily trackable -- what got changed by whom when?</li>
							<li>No easy way to enforce visibility and review of changes</li>
							<li>Hard to tell what depends on what</li>
						</ul>
					</aside>
				</section>

				<section>
					<h3>Difficulty</h3>
					<ul>
						<li>Almost impossible to replicate</li>
						<li>Different APIs for different cloud providers</li>
						<li>Tedious and prone to errors</li>
					</ul>

					<aside class="notes">
						<ul>
							<li>Manual configuration and setting makes it really difficult to replicate</li>
							<li>Imagine having to set up multiple environments (like staging and production)</li>
							<li>Imagine trying to configure something repetitively: e.g. AWS config for ALL regions. Enable AWS Guard Duty for
								ALL regions (as recommended by AWS).</li>
							<li>You can try to automate this but everyone has their own (different) APIs</li>
						</ul>
					</aside>
				</section>
			</section>

			<section>
				<section>
					<h2>Infrastructure as Code</h2>

					Provision, update, and manage your cloud infrastructure with code.
				</section>

				<section>
					<h3>Benefits</h3>
					<ul>
						<li>Automated</li>
						<li>Version control with VCS like Git</li>
						<li>Replicate just by "copy/pasting" or changing variables</li>
						<li>"Just" read the code to figure out details</li>
						<li>"Just" read the code to figure out dependencies</li>
						<li>Abstraction and reusability</li>
					</ul>
				</section>

				<section>
					<h3>Terraform</h3>
					<ul>
						<li>FOSS and paid versions</li>
						<li>Declarative configuration</li>
						<li>Single format across multiple providers</li>
						<li>Huge list of providers supported</li>
					</ul>

					<aside class="notes" data-markdown>
						<textarea data-template>
							- “Workflow-level abstraction”: Single workflow to provision resources across many provider by writing them in a common configuration
							format and invoked from a single place
							- Terraform will determine the dependencies and relationship between resources.
							- Terraform shows you a plan first before applying any changes, including any diffs
							- Terraform also allows you to manage the provisioning configuration of resources across a huge range of providers, including Kubenetes, Cloudflare and so on

						</textarea>
					</aside>
				</section>

				<section>
					<h3>Ansible/Chef/Puppet</h3>
					<ul>
						<li>Configuration management that can also manage infrastructure</li>
						<li>More "procedural" form of provisioning</li>
						<li>Works well with Terraform — configure after Terraform provisions</li>
					</ul>
				</section>

				<section>
					<h3>CloudFormation/Heat</h3>
					<ul>
						<li>Specific to the service</li>
						<li>Each service has its own syntax</li>
					</ul>
				</section>
			</section>

			<section>
				<section>
					<h2>Launching an EC2 Instance</h2>

					<ul>
						<li>Create an EC2 Instance</li>
						<li>Create security group rule to allow SSH access</li>
					</ul>
				</section>

				<section>
					<h3>Provider</h3>
					<div style="display: flex; flex-direction: column">
						<div>
							<ul>
								<li>Providers are plugins</li>
							</ul>
						</div>
						<div>
							<pre>provider &quot;<font color="#AD7FA8">aws</font>&quot; <font color="#FFD7D7">{</font>
  <font color="#FCE94F">version</font> = &quot;<font color="#AD7FA8">~&gt; 1.33</font>&quot;
  <font color="FCE94F">region</font>  = &quot;<font color="#AD7FA8">${var.aws_region}</font>&quot;
<font color="#FFD7D7">}</font></pre>
						</div>

					</div>
				</section>

				<section>
					<h3>variables</h3>
					<div class="flex_box">
						<div>
							<ul>
								<li>Variables allows reusability.</li>
								<li>Define different variables for different "instances" or enrivonments</li>
								<li>Many ways to manage environment in Terraform.</li>
								<li>Provide values at run time with `varfiles`.</li>
							</ul>
						</div>
						<div>
							<script src="https://gist.github.com/lawliet89/f02f7cd3a81379ef728535b31992a5f4.js"></script>
						</div>
					</div>
				</section>

				<section>
					<h3>Security Group Rules</h3>
					<div class="flex_box">
						<div>
							<ul>
								<li>Firewall rules for instances</li>
								<li>Use Interpolation to "refer" to other Terraform resources</li>
								<li>Creates implicit dependencies</li>
								<li>Terraform will figure out the rest</li>
							</ul>
						</div>
						<div>
							<script src="https://gist.github.com/lawliet89/ad5aba366bb8391cfc232dcd7ffff73b.js"></script>
						</div>
					</div>
				</section>

				<section>
					<h3>AMI</h3>
					<div class="flex_box">
						<div>
							<ul>
								<li>Find image to launch instance</li>
								<li>Use `data` sources to refer to existing infrastructure</li>
								<li>No need to hardcode AMI</li>
							</ul>
						</div>
						<div>
							<script src="https://gist.github.com/lawliet89/1df80b478bb922570f5c09c051a7ffe5.js"></script>
						</div>
					</div>
				</section>

				<section>
					<h3>Instance</h3>
					<div class="flex_box">
						<div>
							<ul>
								<li>Finally "deploy" the instance</li>
								<li>Interpolate other resources</li>
							</ul>
						</div>
						<div>
							<script src="https://gist.github.com/lawliet89/f5a3d99974946b3df4b4f60cb06fb05c.js"></script>
						</div>
					</div>
				</section>

				<section>
					<h3>Terraform Execution</h3>
					<div class="flex_box">
						<div>
							<ul>
								<li>Desired state: Configuration files</li>
								<li>Actual state: AWS Infrastructure</li>
								<li>Known State: Terraform State</li>
								<li>Terraform figures out the dependencies and the steps required to create the resources.</li>
							</ul>
						</div>
						<div><img src="images/tf-exec.png"></div>
					</div>
				</section>

				<section>
					<h3>Plan</h3>
					<asciinema-player src="demo_ec2/casts/plan.cast" preload speed="2"></asciinema-player>
				</section>

				<section>
					<h3>Plan</h3>
					<div style="height: 70vh; overflow: auto; font-size: 75%">
<pre>An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  <font color="#4E9A06">+</font> create

Terraform will perform the following actions:

<font color="#4E9A06">  +</font> <font color="#4E9A06">aws_instance.instance</font>
      id:                                        &lt;computed&gt;
      ami:                                       &quot;ami-0238c4a6bd553d40a&quot;
      arn:                                       &lt;computed&gt;
      associate_public_ip_address:               &lt;computed&gt;
      availability_zone:                         &lt;computed&gt;
      cpu_core_count:                            &lt;computed&gt;
      cpu_threads_per_core:                      &lt;computed&gt;
      ebs_block_device.#:                        &lt;computed&gt;
      ephemeral_block_device.#:                  &lt;computed&gt;
      get_password_data:                         &quot;false&quot;
      instance_state:                            &lt;computed&gt;
      instance_type:                             &quot;t2.micro&quot;
      ipv6_address_count:                        &lt;computed&gt;
      ipv6_addresses.#:                          &lt;computed&gt;
      key_name:                                  &quot;terraform&quot;
      network_interface.#:                       &lt;computed&gt;
      network_interface_id:                      &lt;computed&gt;
      password_data:                             &lt;computed&gt;
      placement_group:                           &lt;computed&gt;
      primary_network_interface_id:              &lt;computed&gt;
      private_dns:                               &lt;computed&gt;
      private_ip:                                &lt;computed&gt;
      public_dns:                                &lt;computed&gt;
      public_ip:                                 &lt;computed&gt;
      root_block_device.#:                       &quot;1&quot;
      root_block_device.0.delete_on_termination: &quot;true&quot;
      root_block_device.0.volume_id:             &lt;computed&gt;
      root_block_device.0.volume_size:           &quot;8&quot;
      root_block_device.0.volume_type:           &quot;gp2&quot;
      security_groups.#:                         &lt;computed&gt;
      source_dest_check:                         &quot;true&quot;
      subnet_id:                                 &quot;subnet-364a6551&quot;
      tags.%:                                    &quot;3&quot;
      tags.Name:                                 &quot;Terraform Demo&quot;
      tags.Terraform:                            &quot;true&quot;
      tags.Usage:                                &quot;Terraform Talk by Yong Wen&quot;
      tenancy:                                   &lt;computed&gt;
      volume_tags.%:                             &quot;3&quot;
      volume_tags.Name:                          &quot;Terraform Demo&quot;
      volume_tags.Terraform:                     &quot;true&quot;
      volume_tags.Usage:                         &quot;Terraform Talk by Yong Wen&quot;
      vpc_security_group_ids.#:                  &lt;computed&gt;

<font color="#4E9A06">  +</font> <font color="#4E9A06">aws_security_group.instance</font>
      id:                                        &lt;computed&gt;
      arn:                                       &lt;computed&gt;
      description:                               &quot;Managed by Terraform&quot;
      egress.#:                                  &lt;computed&gt;
      ingress.#:                                 &lt;computed&gt;
      name:                                      &quot;Terraform Demo&quot;
      owner_id:                                  &lt;computed&gt;
      revoke_rules_on_delete:                    &quot;false&quot;
      tags.%:                                    &quot;3&quot;
      tags.Name:                                 &quot;Terraform Demo&quot;
      tags.Terraform:                            &quot;true&quot;
      tags.Usage:                                &quot;Terraform Talk by Yong Wen&quot;
      vpc_id:                                    &quot;vpc-dac9bcbd&quot;

<font color="#4E9A06">  +</font> <font color="#4E9A06">aws_security_group_rule.ssh_inbound</font>
      id:                                        &lt;computed&gt;
      cidr_blocks.#:                             &quot;1&quot;
      cidr_blocks.0:                             &quot;10.0.0.0/8&quot;
      from_port:                                 &quot;22&quot;
      protocol:                                  &quot;tcp&quot;
      security_group_id:                         &quot;${aws_security_group.instance.id}&quot;
      self:                                      &quot;false&quot;
      source_security_group_id:                  &lt;computed&gt;
      to_port:                                   &quot;22&quot;
      type:                                      &quot;ingress&quot;


<b>Plan:</b> 3 to add, 0 to change, 0 to destroy.
</pre>
					</div>
				</section>
				<section>
					<div style="max-height: 90vh; overflow: auto;">
						<img src="demo_ec2/graph.svg">
					</div>
				</section>
				<section>
					<h3>Executing the Plan</h3>
					<asciinema-player src="demo_ec2/casts/create.cast" preload speed="2"></asciinema-player>
				</section>
				<section>
					<h3>Modify</h3>
					<div class="flex_box" style="flex-direction: column;">
						<div>
							<ul>
								<li>Plan will show the diff in what Terraform will do</li>
								<li>Some changes are destructive</li>
								<li>Some are "in-place"</li>
							</ul>
						</div>
						<div style="font-size: 75%; max-height: 50vh; overflow: auto;">
							<pre>An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  <font color="#C4A000">~</font> update in-place
<font color="#CC0000">-</font>/<font color="#4E9A06">+</font> destroy and then create replacement

Terraform will perform the following actions:

<font color="#C4A000">  ~</font> <font color="#C4A000">aws_instance.instance</font>
      tags.%:                   &quot;3&quot; =&gt; &quot;4&quot;
      tags.Demo:                &quot;&quot; =&gt; &quot;true&quot;
      volume_tags.%:            &quot;3&quot; =&gt; &quot;4&quot;
      volume_tags.Demo:         &quot;&quot; =&gt; &quot;true&quot;

<font color="#C4A000">  ~</font> <font color="#C4A000">aws_security_group.instance</font>
      tags.%:                   &quot;3&quot; =&gt; &quot;4&quot;
      tags.Demo:                &quot;&quot; =&gt; &quot;true&quot;

<font color="#CC0000">-</font>/<font color="#4E9A06">+</font> <font color="#C4A000">aws_security_group_rule.ssh_inbound </font><font color="#EF2929"><b>(new resource required)</b></font>
      id:                       &quot;sgrule-68829610&quot; =&gt; &lt;computed&gt; <font color="#CC0000">(forces new resource)</font>
      cidr_blocks.#:            &quot;1&quot; =&gt; &quot;2&quot; <font color="#CC0000">(forces new resource)</font>
      cidr_blocks.0:            &quot;10.0.0.0/8&quot; =&gt; &quot;10.0.0.0/8&quot;
      cidr_blocks.1:            &quot;&quot; =&gt; &quot;192.168.0.0/16&quot; <font color="#CC0000">(forces new resource)</font>
      from_port:                &quot;22&quot; =&gt; &quot;22&quot;
      protocol:                 &quot;tcp&quot; =&gt; &quot;tcp&quot;
      security_group_id:        &quot;sg-062b707aad99b2c9b&quot; =&gt; &quot;sg-062b707aad99b2c9b&quot;
      self:                     &quot;false&quot; =&gt; &quot;false&quot;
      source_security_group_id: &quot;&quot; =&gt; &lt;computed&gt;
      to_port:                  &quot;22&quot; =&gt; &quot;22&quot;
      type:                     &quot;ingress&quot; =&gt; &quot;ingress&quot;


<b>Plan:</b> 1 to add, 2 to change, 1 to destroy.
</pre>
						</div>
					</div>
				</section>

				<section>
					<h3>Destroy!</h3>
					<div class="flex_box" style="flex-direction: column">
						<div>
							<ul>
								<li>Easy to clean up and destroy</li>
								<li>(Also easy to re-create!)</li>
								<li>Reverse of create — Terraform calculates the dependencies and destroys them in reverse.</li>
							</ul>
						</div>

						<div style="height: 70vh; overflow: auto; font-size: 75%">
<pre>An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  <font color="#CC0000">-</font> destroy

Terraform will perform the following actions:

<font color="#CC0000">  -</font> <font color="#CC0000">aws_instance.instance</font>

<font color="#CC0000">  -</font> <font color="#CC0000">aws_security_group.instance</font>

<font color="#CC0000">  -</font> <font color="#CC0000">aws_security_group_rule.ssh_inbound</font>


<b>Plan:</b> 0 to add, 0 to change, 3 to destroy.

<b>Do you really want to destroy all resources?</b>
  Terraform will destroy all your managed infrastructure, as shown above.
  There is no undo. Only &apos;yes&apos; will be accepted to confirm.
</pre>
						</div>
					</div>
				</section>
			</section>

			<section>
				<section>
					<h2>Demo</h2>
				</section>

				<section>
					<h3>Application</h3>
					<ul>
						<li>Silly Chatroom</li>
						<li>Stateless Static Javascript Client</li>
						<li>Stateful Server</li>
					</ul>

					<div>
						<img src="https://camo.githubusercontent.com/e2ccdf4567b426a81a11c081ee7bdd5dbbd13210/687474703a2f2f692e696d6775722e636f6d2f4a316b3769776e2e706e67"
						 style="max-height: 240px;"> <br>
						<a href="https://github.com/gyng/comicchat">github.com/gyng/comicchat</a>
					</div>
				</section>

				<section>
					<h3>Basic Idea</h3>
					<ul>
						<li>Autoscaling Group (ASG) for clients and servers separately</li>
						<li>One Elastic Load Balancer (ELB) with different listener rules to target the ASG</li>
					</ul>
				</section>

				<section>
					<h3>Diagram</h3>
					<img src="demo/demo.svg" style="max-height: 85vh; background-color: white;">
				</section>

				<section>
					<h3>Hidden Details&hellip;</h3>
					<ul>
						<li>Security groups rules between ELB and EC2 instances</li>
						<li>Launch configuration details for ASG</li>
						<li>Listener for ports</li>
						<li>Redirect HTTP ➡ HTTPS listner</li>
						<li>Certificate for HTTPS</li>
						<li>Listener rules to handle different host names</li>
						<li>Target groups for ASG</li>
						<li>Dependencies&hellip; which should I create first?</li>
						<li>&hellip;</li>
					</ul>
				</section>

				<section>
					<h3>Terraform Implementation</h3>
					Source code at <a href="https://github.com/lawliet89/terraform-talk/tree/master/demo" target="_blank">github.com/lawliet89/terraform-talk/tree/master/demo</a>
				</section>

				<section>
					<h3>Dependency Graph</h3>
					<div style="overflow: auto;">
						<a href="demo/graph.svg" target="_blank"><img src="demo/graph.svg"></a>
					</div>
				</section>

				<section>
					<h3><code>terraform init</code></h3>
					<asciinema-player src="demo/casts/init.cast" preload></asciinema-player>
				</section>

				<section>
					<h3><code>terraform plan</code></h3>
					<asciinema-player src="demo/casts/plan.cast" preload speed="2"></asciinema-player>
				</section>

				<section>
					<h3><code>terraform apply</code></h3>
					<asciinema-player src="demo/casts/apply-1.cast" preload speed="5"></asciinema-player>
				</section>

				<section>
					<h3>Changing and fixing <code>terraform apply</code></h3>
					<asciinema-player src="demo/casts/apply-2.cast" preload speed="2"></asciinema-player>
				</section>

				<section>
					<h3>Changing implementation details (<a href="https://github.com/lawliet89/terraform-talk/commit/dbb4029952a48db4736e994baee8a485036eba9e"
						 target="_blank">diff</a>)</h3>
					<asciinema-player src="demo/casts/apply-3.cast" preload speed="2"></asciinema-player>
				</section>

				<section>
					<h3>It works!</h3>
					<a href="https://chat.gahmen.tech">chat.gahmen.tech</a>

					<img src="demo/screenshot.png">
				</section>

				<section>
					<h3><code>terraform destroy</code> — Ω</h3>
					<asciinema-player src="demo/casts/destroy.cast" preload speed="5"></asciinema-player>
				</section>

				<section>
					<h3>Recreation — α</h3>
					<asciinema-player src="demo/casts/reapply.cast" preload speed="5"></asciinema-player>
				</section>
			</section>

			<section>
				<section>
					<h2>Code Walkthrough</h2>
					Source code at <a href="https://github.com/lawliet89/terraform-talk/tree/master/demo" target="_blank">github.com/lawliet89/terraform-talk/tree/master/demo</a>
				</section>

				<section>
					<h4><code>main.tf</code></h4>
					<script src="https://gist.github.com/lawliet89/0fc9196ca0fcf6cb50e22d948ee97286.js"></script>
				</section>

				<section>
					<h4>Required <code>variables.tf</code></h4>
					<script src="https://gist.github.com/lawliet89/b2ae62f9481c1b5cda2bfc929aeb33b9.js"></script>
				</section>

				<section>
					<h4>Optional <code>variables.tf</code></h4>
					<script src="https://gist.github.com/lawliet89/db9bdeac311caba12c682debff5c90a8.js"></script>
				</section>

				<section>
					<h4>Autoscaling Group</h4>
					<script src="https://gist.github.com/lawliet89/e3670e4b1ba06fcd33f53ec5c07b870c.js"></script>
				</section>

				<section>
					<h4>Launch Configuration</h4>
					<div style="transform: scale(0.8); transform-origin: center top">
						<script src="https://gist.github.com/lawliet89/218c246ca5dc1751765a0e036f1452fa.js"></script>
					</div>
				</section>

				<section>
					<h4>Security Group Rules</h4>
					<script src="https://gist.github.com/lawliet89/6293525a06cc85e48372b1cb10f0186d.js"></script>
				</section>

				<section>
					<h4>ELB</h4>
					<script src="https://gist.github.com/lawliet89/83e5885a2df80d313fe4221011727aad.js"></script>
				</section>

				<section>
					<h4>Listeners</h4>
					<div style="transform: scale(0.85); transform-origin: center top">
						<script src="https://gist.github.com/lawliet89/63c1f6ed32a15e67d25832fb3712d623.js"></script>
					</div>
				</section>

				<section>
					<div style="transform: scale(0.75); transform-origin: center top">
						<script src="https://gist.github.com/lawliet89/d1b1fab79da782413b4b1d0d5b6d3c44.js"></script>
					</div>
				</section>

				<section>
					<p>Don't forget extra security rules!</p>
					<script src="https://gist.github.com/lawliet89/eb85987749f754034eed228dedfb8d15.js"></script>
				</section>

				<section>
					<p>Repeat for the server.</p>
				</section>

				<section>
					<h4>Route 53</h4>

					<p>The order we write this does not matter.</p>

					<script src="https://gist.github.com/lawliet89/baa2528f23fd659e4b3c70f8a4e1d172.js"></script>
				</section>
			</section>

			<section>
				<section>
					<h2>Bonus: Enable GuardDuty and AWS Config for all regions</h2>
				</section>

				<section>
					<h3>Open Source Module</h3>
					<p>We will make use of an open source module to help us along.</p>
					<p><a href="https://github.com/nozaq/terraform-aws-secure-baseline">github.com/nozaq/terraform-aws-secure-baseline</a></a></p>
				</section>

				<section>
					<div style="transform: scale(0.9); transform-origin: center top">
						<script src="https://gist.github.com/lawliet89/32650530a77a2fa34348d0c3145da57f.js"></script>
					</div>
				</section>
			</section>

			<section>
				<ul>
					<li>Slides: <a href="https://terraform.gds-gov.tech">terraform.gds-gov.tech</a></li>
					<li>Source code and demo code: <a href="https://github.com/lawliet89/terraform-talk">github.com/lawliet89/terraform-talk</a></li>
				</ul>
			</section>
		</div>
	</div>

	<script src="lib/js/head.min.js"></script>
	<script src="js/reveal.js"></script>
	<script src="lib/js/asciinema-player.js"></script>

	<script>
		// More info about config & dependencies:
		// - https://github.com/hakimel/reveal.js#configuration
		// - https://github.com/hakimel/reveal.js#dependencies
		Reveal.initialize({
			fragmentInURL: true,
			progress: true,
			history: true,
			dependencies: [
				{ src: 'plugin/markdown/marked.js' },
				{ src: 'plugin/markdown/markdown.js' },
				{ src: 'plugin/notes/notes.js', async: true },
				{
					src: 'plugin/highlight/highlight.js',
					async: true,
					callback: function () {
						hljs.initHighlightingOnLoad();
					}
				}
			]
		});
	</script>
</body>

</html>
